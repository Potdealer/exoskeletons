<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EXOSKELETONS — Mint</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0a;--card:#111;--border:#222;--gold:#FFD700;--green:#00FFAA;--dim:#666;--text:#ccc}
body{background:var(--bg);color:var(--text);font-family:'Courier New',monospace;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px}
h1{color:var(--gold);font-size:28px;letter-spacing:4px;margin:20px 0 5px}
.sub{color:var(--dim);font-size:12px;margin-bottom:30px}
.card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:20px;margin:10px 0;width:100%;max-width:520px}
.card h2{color:var(--green);font-size:14px;letter-spacing:2px;margin-bottom:15px;border-bottom:1px solid var(--border);padding-bottom:8px}
.stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat{text-align:center;padding:8px;background:#0d0d0d;border-radius:4px}
.stat .val{font-size:20px;color:var(--gold);font-weight:bold}
.stat .lbl{font-size:10px;color:var(--dim);margin-top:4px;text-transform:uppercase;letter-spacing:1px}
.row{display:flex;gap:10px;margin-bottom:12px;align-items:center}
.row label{width:100px;font-size:12px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;flex-shrink:0}
.row select,.row input{flex:1;background:#0d0d0d;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:4px;font-family:inherit;font-size:13px}
.row input[type=color]{padding:2px;height:36px;cursor:pointer}
.preview-wrap{display:flex;justify-content:center;margin:15px 0}
#preview{width:200px;height:200px;border:1px solid var(--border);border-radius:8px;background:#050505}
button{width:100%;padding:14px;font-family:inherit;font-size:16px;font-weight:bold;letter-spacing:2px;border:none;border-radius:6px;cursor:pointer;transition:all 0.2s}
#connectBtn{background:transparent;border:2px solid var(--green);color:var(--green)}
#connectBtn:hover{background:var(--green);color:#000}
#mintBtn{background:var(--gold);color:#000;margin-top:10px}
#mintBtn:hover{background:#e6c200}
#mintBtn:disabled{background:#333;color:#666;cursor:not-allowed}
.status{text-align:center;padding:10px;font-size:13px;margin-top:10px;border-radius:4px}
.status.ok{color:var(--green);background:#001a10}
.status.err{color:#ff4444;background:#1a0000}
.status.pending{color:var(--gold);background:#1a1500}
.wl-badge{display:inline-block;background:#1a1500;color:var(--gold);padding:3px 8px;border-radius:3px;font-size:11px;margin-top:5px}
.free-badge{background:#001a10;color:var(--green)}
.addr{font-size:11px;color:var(--dim);word-break:break-all;text-align:center;margin-top:5px}
a{color:var(--green);text-decoration:none}
a:hover{text-decoration:underline}
.footer{margin-top:30px;text-align:center;font-size:11px;color:var(--dim);line-height:1.8}
.hidden{display:none}
</style>
</head>
<body>

<h1>EXOSKELETONS</h1>
<p class="sub">onchain identity NFTs for AI agents — Base</p>

<!-- CONNECT -->
<div class="card" id="connectCard">
<button id="connectBtn" onclick="connect()">CONNECT WALLET</button>
<div id="walletInfo" class="hidden">
<p class="addr" id="addrDisplay"></p>
<div id="badges" style="text-align:center;margin-top:5px"></div>
</div>
</div>

<!-- STATS -->
<div class="card">
<h2>// NETWORK</h2>
<div class="stats">
<div class="stat"><div class="val" id="sPhase">--</div><div class="lbl">Phase</div></div>
<div class="stat"><div class="val" id="sPrice">--</div><div class="lbl">Price</div></div>
<div class="stat"><div class="val" id="sMinted">--</div><div class="lbl">Minted</div></div>
<div class="stat"><div class="val" id="sGenesis">--</div><div class="lbl">Genesis Left</div></div>
</div>
</div>

<!-- CONFIG -->
<div class="card">
<h2>// CONFIGURE</h2>

<div class="row">
<label>Shape</label>
<select id="cfgShape" onchange="updatePreview()">
<option value="0">Hexagon</option>
<option value="1">Circle</option>
<option value="2">Diamond</option>
<option value="3">Shield</option>
<option value="4">Octagon</option>
<option value="5">Triangle</option>
</select>
</div>

<div class="row">
<label>Primary</label>
<input type="color" id="cfgPrimary" value="#00BFFF" onchange="updatePreview()">
</div>

<div class="row">
<label>Secondary</label>
<input type="color" id="cfgSecondary" value="#3C0078" onchange="updatePreview()">
</div>

<div class="row">
<label>Symbol</label>
<select id="cfgSymbol" onchange="updatePreview()">
<option value="0">None</option>
<option value="1">Eye</option>
<option value="2">Gear</option>
<option value="3">Bolt</option>
<option value="4">Star</option>
<option value="5">Wave</option>
<option value="6">Node</option>
<option value="7">Diamond</option>
</select>
</div>

<div class="row">
<label>Pattern</label>
<select id="cfgPattern" onchange="updatePreview()">
<option value="0">None</option>
<option value="1">Grid</option>
<option value="2">Dots</option>
<option value="3">Lines</option>
<option value="4">Circuits</option>
<option value="5">Rings</option>
</select>
</div>

<div class="preview-wrap">
<svg id="preview" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"></svg>
</div>
</div>

<!-- MINT -->
<div class="card">
<h2>// MINT</h2>
<button id="mintBtn" onclick="mint()" disabled>MINT EXOSKELETON</button>
<div id="mintStatus"></div>
</div>

<div class="footer">
CC0 — No rights reserved<br>
Built by <a href="https://github.com/Potdealer/exoskeletons" target="_blank">potdealer & Ollie</a><br>
Contract: <a href="https://basescan.org/address/0x8241BDD5009ed3F6C99737D2415994B58296Da0d" target="_blank">0x8241...Da0d</a><br>
<span style="color:var(--gold)">Chain: Base (8453)</span>
</div>

<script>
const CORE = "0x8241BDD5009ed3F6C99737D2415994B58296Da0d";
const CHAIN_ID = "0x2105"; // 8453
const RPC = "https://mainnet.base.org";

// Function selectors
const SEL = {
  mint: "0x7ba0e2e7",
  getMintPrice: "0xa7f93ebd",
  getMintPhase: "0xc52766c6",
  nextTokenId: "0x75794a3c",
  totalSupply: "0x18160ddd",
  whitelist: "0x9b19251a",
  usedFreeMint: "0x61273028",
};

let account = null;
let mintPrice = 0n;

// ── Hex helpers ─────────────────────────────────────────────
function hexToInt(h) { return h === "0x" ? 0n : BigInt(h); }
function padAddr(a) { return "0x" + a.toLowerCase().replace("0x","").padStart(64,"0"); }
function pad32(n) { return n.toString(16).padStart(64,"0"); }
function hexToStr(h) {
  // ABI-encoded string: offset(32) + length(32) + data
  h = h.replace("0x","");
  if (h.length < 128) return "";
  const len = parseInt(h.substring(64,128), 16);
  const data = h.substring(128, 128 + len * 2);
  let s = "";
  for (let i = 0; i < data.length; i += 2) s += String.fromCharCode(parseInt(data.substring(i, i+2), 16));
  return s;
}
function toWei(eth) { return BigInt(Math.round(eth * 1e18)); }
function fromWei(w) { return Number(w) / 1e18; }

// ── RPC call ────────────────────────────────────────────────
async function rpc(data) {
  const r = await fetch(RPC, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({jsonrpc:"2.0",method:"eth_call",params:[{to:CORE,data},"latest"],id:1})
  });
  const j = await r.json();
  return j.result || "0x";
}

// ── Load stats ──────────────────────────────────────────────
async function loadStats() {
  try {
    const [priceHex, phaseHex, nextHex, supplyHex] = await Promise.all([
      rpc(SEL.getMintPrice),
      rpc(SEL.getMintPhase),
      rpc(SEL.nextTokenId),
      rpc(SEL.totalSupply),
    ]);

    mintPrice = hexToInt(priceHex);
    const phase = hexToStr(phaseHex);
    const next = Number(hexToInt(nextHex));
    const supply = Number(hexToInt(supplyHex));
    const genesisLeft = Math.max(0, 1000 - next + 1);

    document.getElementById("sPhase").textContent = phase.toUpperCase();
    document.getElementById("sPrice").textContent = fromWei(mintPrice) + " ETH";
    document.getElementById("sMinted").textContent = supply;
    document.getElementById("sGenesis").textContent = genesisLeft;
  } catch(e) {
    console.error("Stats error:", e);
  }
}

// ── Connect wallet ──────────────────────────────────────────
async function connect() {
  if (!window.ethereum) {
    showStatus("No wallet detected. Install MetaMask or use a Web3 browser.", "err");
    return;
  }

  try {
    // Request accounts
    const accounts = await window.ethereum.request({method:"eth_requestAccounts"});
    account = accounts[0];

    // Switch to Base if needed
    try {
      await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:CHAIN_ID}]});
    } catch(e) {
      if (e.code === 4902) {
        await window.ethereum.request({method:"wallet_addEthereumChain",params:[{
          chainId: CHAIN_ID,
          chainName: "Base",
          nativeCurrency: {name:"ETH",symbol:"ETH",decimals:18},
          rpcUrls: ["https://mainnet.base.org"],
          blockExplorerUrls: ["https://basescan.org"]
        }]});
      }
    }

    // Update UI
    document.getElementById("connectBtn").textContent = account.slice(0,6) + "..." + account.slice(-4);
    document.getElementById("connectBtn").style.borderColor = "var(--gold)";
    document.getElementById("connectBtn").style.color = "var(--gold)";
    document.getElementById("walletInfo").classList.remove("hidden");
    document.getElementById("addrDisplay").textContent = account;
    document.getElementById("mintBtn").disabled = false;

    // Check whitelist status
    const wlHex = await rpc(SEL.whitelist + padAddr(account).slice(2));
    const isWL = hexToInt(wlHex) > 0n;
    const freeHex = await rpc(SEL.usedFreeMint + padAddr(account).slice(2));
    const usedFree = hexToInt(freeHex) > 0n;

    const badges = document.getElementById("badges");
    if (isWL) {
      badges.innerHTML = '<span class="wl-badge">WHITELISTED</span>';
      if (!usedFree) {
        badges.innerHTML += ' <span class="wl-badge free-badge">FREE MINT AVAILABLE</span>';
        document.getElementById("mintBtn").textContent = "MINT EXOSKELETON (FREE)";
      }
    }

  } catch(e) {
    showStatus("Connection failed: " + e.message, "err");
  }
}

// ── Build config bytes ──────────────────────────────────────
function getConfig() {
  const shape = parseInt(document.getElementById("cfgShape").value);
  const p = document.getElementById("cfgPrimary").value;
  const s = document.getElementById("cfgSecondary").value;
  const symbol = parseInt(document.getElementById("cfgSymbol").value);
  const pattern = parseInt(document.getElementById("cfgPattern").value);

  const pr = parseInt(p.slice(1,3),16), pg = parseInt(p.slice(3,5),16), pb = parseInt(p.slice(5,7),16);
  const sr = parseInt(s.slice(1,3),16), sg = parseInt(s.slice(3,5),16), sb = parseInt(s.slice(5,7),16);

  return [shape, pr, pg, pb, sr, sg, sb, symbol, pattern];
}

function encodeConfig(cfg) {
  // ABI encode bytes: offset(32) + length(32) + data(padded to 32)
  const offset = pad32(32);
  const length = pad32(9);
  let data = "";
  for (const b of cfg) data += b.toString(16).padStart(2, "0");
  data = data.padEnd(64, "0"); // pad to 32 bytes
  return offset + length + data;
}

// ── Mint ────────────────────────────────────────────────────
async function mint() {
  if (!account) { showStatus("Connect wallet first", "err"); return; }

  const btn = document.getElementById("mintBtn");
  btn.disabled = true;
  btn.textContent = "MINTING...";
  showStatus("Confirm transaction in your wallet...", "pending");

  try {
    const cfg = getConfig();
    const calldata = SEL.mint + encodeConfig(cfg);

    // Check if free mint
    const wlHex = await rpc(SEL.whitelist + padAddr(account).slice(2));
    const isWL = hexToInt(wlHex) > 0n;
    const freeHex = await rpc(SEL.usedFreeMint + padAddr(account).slice(2));
    const usedFree = hexToInt(freeHex) > 0n;
    const value = (isWL && !usedFree) ? "0x0" : "0x" + mintPrice.toString(16);

    const txHash = await window.ethereum.request({
      method: "eth_sendTransaction",
      params: [{
        from: account,
        to: CORE,
        data: calldata,
        value: value,
        chainId: CHAIN_ID,
      }]
    });

    showStatus('Minting... TX: <a href="https://basescan.org/tx/' + txHash + '" target="_blank">' + txHash.slice(0,14) + '...</a>', "pending");

    // Poll for receipt
    let receipt = null;
    for (let i = 0; i < 60; i++) {
      await new Promise(r => setTimeout(r, 2000));
      const resp = await fetch(RPC, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({jsonrpc:"2.0",method:"eth_getTransactionReceipt",params:[txHash],id:1})
      });
      const j = await resp.json();
      if (j.result) { receipt = j.result; break; }
    }

    if (receipt && receipt.status === "0x1") {
      // Parse token ID from Transfer event (topic 0xddf252ad...)
      let tokenId = "?";
      for (const log of receipt.logs) {
        if (log.address.toLowerCase() === CORE.toLowerCase() && log.topics[0] === "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef") {
          tokenId = Number(BigInt(log.topics[3]));
          break;
        }
      }
      showStatus('Minted Exoskeleton #' + tokenId + '! <a href="https://basescan.org/tx/' + txHash + '" target="_blank">View TX</a>', "ok");
      btn.textContent = "MINTED #" + tokenId;
      loadStats(); // refresh
    } else if (receipt) {
      showStatus("Transaction reverted. Check your wallet for details.", "err");
      btn.textContent = "MINT EXOSKELETON";
      btn.disabled = false;
    } else {
      showStatus("Transaction pending... check Basescan.", "pending");
      btn.textContent = "MINT EXOSKELETON";
      btn.disabled = false;
    }

  } catch(e) {
    showStatus("Mint failed: " + (e.message || e), "err");
    btn.textContent = "MINT EXOSKELETON";
    btn.disabled = false;
  }
}

// ── Preview SVG ─────────────────────────────────────────────
function updatePreview() {
  const cfg = getConfig();
  const svg = document.getElementById("preview");
  const p = document.getElementById("cfgPrimary").value;
  const s = document.getElementById("cfgSecondary").value;
  const shapes = {
    0: '<polygon points="100,20 170,55 170,125 100,160 30,125 30,55" fill="none" stroke="'+p+'" stroke-width="2"/>',
    1: '<circle cx="100" cy="100" r="70" fill="none" stroke="'+p+'" stroke-width="2"/>',
    2: '<polygon points="100,20 180,100 100,180 20,100" fill="none" stroke="'+p+'" stroke-width="2"/>',
    3: '<path d="M40,30 L160,30 L160,120 Q100,180 40,120 Z" fill="none" stroke="'+p+'" stroke-width="2"/>',
    4: '<polygon points="70,20 130,20 170,55 170,125 130,160 70,160 30,125 30,55" fill="none" stroke="'+p+'" stroke-width="2"/>',
    5: '<polygon points="100,20 180,160 20,160" fill="none" stroke="'+p+'" stroke-width="2"/>',
  };
  const symbols = {
    0: '',
    1: '<ellipse cx="100" cy="95" rx="22" ry="14" fill="none" stroke="'+s+'" stroke-width="1.5"/><circle cx="100" cy="95" r="6" fill="'+s+'"/>',
    2: '<polygon points="100,78 108,85 112,95 108,105 100,112 92,105 88,95 92,85" fill="none" stroke="'+s+'" stroke-width="1.5"/>',
    3: '<path d="M100,75 L106,90 L118,95 L106,100 L100,115 L94,100 L82,95 L94,90 Z" fill="none" stroke="'+s+'" stroke-width="1.5"/>',
    4: '<polygon points="100,75 104,88 118,88 107,96 111,110 100,102 89,110 93,96 82,88 96,88" fill="none" stroke="'+s+'" stroke-width="1.5"/>',
    5: '<path d="M65,95 Q82,75 100,95 Q118,115 135,95" fill="none" stroke="'+s+'" stroke-width="1.5"/>',
    6: '<circle cx="85" cy="95" r="6" fill="'+s+'"/><circle cx="115" cy="95" r="6" fill="'+s+'"/><line x1="91" y1="95" x2="109" y2="95" stroke="'+s+'" stroke-width="1.5"/>',
    7: '<polygon points="100,80 115,95 100,110 85,95" fill="none" stroke="'+s+'" stroke-width="1.5"/><polygon points="100,85 110,95 100,105 90,95" fill="'+s+'" fill-opacity="0.3"/>',
  };
  const patterns = {
    0: '',
    1: '<line x1="0" y1="60" x2="200" y2="60" stroke="'+p+'" stroke-opacity="0.1"/><line x1="0" y1="140" x2="200" y2="140" stroke="'+p+'" stroke-opacity="0.1"/><line x1="60" y1="0" x2="60" y2="200" stroke="'+p+'" stroke-opacity="0.1"/><line x1="140" y1="0" x2="140" y2="200" stroke="'+p+'" stroke-opacity="0.1"/>',
    2: '<circle cx="40" cy="40" r="2" fill="'+p+'" fill-opacity="0.15"/><circle cx="100" cy="40" r="2" fill="'+p+'" fill-opacity="0.15"/><circle cx="160" cy="40" r="2" fill="'+p+'" fill-opacity="0.15"/><circle cx="70" cy="70" r="2" fill="'+p+'" fill-opacity="0.15"/><circle cx="130" cy="70" r="2" fill="'+p+'" fill-opacity="0.15"/><circle cx="40" cy="160" r="2" fill="'+p+'" fill-opacity="0.15"/><circle cx="100" cy="160" r="2" fill="'+p+'" fill-opacity="0.15"/><circle cx="160" cy="160" r="2" fill="'+p+'" fill-opacity="0.15"/>',
    3: '<line x1="0" y1="0" x2="200" y2="200" stroke="'+p+'" stroke-opacity="0.08"/><line x1="40" y1="0" x2="200" y2="160" stroke="'+p+'" stroke-opacity="0.08"/><line x1="0" y1="40" x2="160" y2="200" stroke="'+p+'" stroke-opacity="0.08"/><line x1="80" y1="0" x2="200" y2="120" stroke="'+p+'" stroke-opacity="0.08"/><line x1="0" y1="80" x2="120" y2="200" stroke="'+p+'" stroke-opacity="0.08"/>',
    4: '<path d="M30,100 L60,100 L60,70 L90,70 L90,100 L120,100" fill="none" stroke="'+p+'" stroke-opacity="0.12" stroke-width="1"/><path d="M80,130 L110,130 L110,160 L140,160 L140,130 L170,130" fill="none" stroke="'+p+'" stroke-opacity="0.12" stroke-width="1"/><circle cx="60" cy="70" r="2" fill="'+p+'" fill-opacity="0.2"/><circle cx="90" cy="70" r="2" fill="'+p+'" fill-opacity="0.2"/><circle cx="110" cy="130" r="2" fill="'+p+'" fill-opacity="0.2"/><circle cx="140" cy="160" r="2" fill="'+p+'" fill-opacity="0.2"/>',
    5: '<circle cx="100" cy="100" r="40" fill="none" stroke="'+p+'" stroke-opacity="0.08"/><circle cx="100" cy="100" r="60" fill="none" stroke="'+p+'" stroke-opacity="0.06"/><circle cx="100" cy="100" r="80" fill="none" stroke="'+p+'" stroke-opacity="0.04"/>',
  };

  svg.innerHTML = '<rect width="200" height="200" fill="#050505"/>'
    + (patterns[cfg[8]] || '')
    + (shapes[cfg[0]] || '')
    + (symbols[cfg[7]] || '')
    + '<text x="100" y="188" fill="'+p+'" font-family="monospace" font-size="8" text-anchor="middle" opacity="0.5">EXOSKELETON</text>';
}

// ── Status display ──────────────────────────────────────────
function showStatus(msg, type) {
  const el = document.getElementById("mintStatus");
  el.innerHTML = msg;
  el.className = "status " + type;
}

// ── Init ────────────────────────────────────────────────────
loadStats();
updatePreview();
setInterval(loadStats, 30000);

// Auto-connect if wallet available
if (window.ethereum) {
  window.ethereum.request({method:"eth_accounts"}).then(accounts => {
    if (accounts.length > 0) {
      connect();
    }
  });
}
</script>
</body>
</html>
